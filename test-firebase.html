<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Test Page - Hobbi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }
        .test-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }
        .success {
            background: #10b981;
        }
        .success:hover {
            background: #059669;
        }
        .danger {
            background: #ef4444;
        }
        .danger:hover {
            background: #dc2626;
        }
        pre {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #0f172a;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #3b82f6;
            padding-left: 10px;
        }
        .log-error {
            border-left-color: #ef4444;
            color: #fca5a5;
        }
        .log-success {
            border-left-color: #10b981;
            color: #6ee7b7;
        }
        input {
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-2">üî• Firebase Test Page</h1>
        <p class="text-gray-400 mb-6">Test authentication and Firestore functions</p>

        <!-- Current User Status -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">Current User Status</h2>
            <div id="userStatus" class="log-entry log-success">
                Loading...
            </div>
        </div>

        <!-- Authentication Tests -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">üîê Authentication Tests</h2>

            <div class="mb-4">
                <h3 class="font-medium mb-2">Email/Password Sign Up</h3>
                <input type="email" id="signupEmail" placeholder="email@example.com" />
                <input type="password" id="signupPassword" placeholder="password (min 6 chars)" />
                <input type="text" id="signupDisplayName" placeholder="Display Name" />
                <button onclick="testSignUp()">Sign Up</button>
            </div>

            <div class="mb-4">
                <h3 class="font-medium mb-2">Email/Password Sign In</h3>
                <input type="email" id="signinEmail" placeholder="email@example.com" />
                <input type="password" id="signinPassword" placeholder="password" />
                <button onclick="testSignIn()">Sign In</button>
            </div>

            <div class="mb-4">
                <h3 class="font-medium mb-2">Google Sign In</h3>
                <button onclick="testGoogleSignIn()" class="success">Sign In with Google</button>
            </div>

            <div>
                <button onclick="testSignOut()" class="danger">Sign Out</button>
            </div>
        </div>

        <!-- Firestore Session Tests -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">üíæ Firestore Session Tests</h2>

            <button onclick="testSaveSession()" class="success">Save Test Session</button>
            <button onclick="testGetSessions()">Get My Sessions</button>
            <button onclick="testDeleteLastSession()" class="danger">Delete Last Session</button>

            <div id="sessionResults" class="log"></div>
        </div>

        <!-- Console Logs -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">üìù Test Logs</h2>
            <button onclick="clearLogs()" class="danger">Clear Logs</button>
            <div id="testLogs" class="log"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            updateProfile
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            deleteDoc,
            query,
            orderBy,
            limit
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config (from your .env)
        const firebaseConfig = {
            apiKey: "AIzaSyBi7wZfSVYszyfxEh1t_sdGyGi-NcskBeY",
            authDomain: "hobbi-bfce4.firebaseapp.com",
            projectId: "hobbi-bfce4",
            storageBucket: "hobbi-bfce4.firebasestorage.app",
            messagingSenderId: "1021314005644",
            appId: "1:1021314005644:web:c4e0bd3013f765adf919a9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;

        // Helper functions
        window.log = (message, type = 'info') => {
            const logsDiv = document.getElementById('testLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        };

        window.clearLogs = () => {
            document.getElementById('testLogs').innerHTML = '';
        };

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            const statusDiv = document.getElementById('userStatus');
            if (user) {
                statusDiv.innerHTML = `
                    <strong>‚úÖ Signed In</strong><br>
                    UID: ${user.uid}<br>
                    Email: ${user.email || 'N/A'}<br>
                    Display Name: ${user.displayName || 'N/A'}
                `;
                statusDiv.className = 'log-entry log-success';
                window.log(`User signed in: ${user.email || user.uid}`, 'success');
            } else {
                statusDiv.innerHTML = '<strong>‚ùå Not Signed In</strong>';
                statusDiv.className = 'log-entry log-error';
                window.log('User signed out', 'info');
            }
        });

        // Auth test functions
        window.testSignUp = async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const displayName = document.getElementById('signupDisplayName').value;

            if (!email || !password) {
                window.log('Please enter email and password', 'error');
                return;
            }

            try {
                window.log('Creating account...', 'info');
                const result = await createUserWithEmailAndPassword(auth, email, password);

                if (displayName) {
                    await updateProfile(result.user, { displayName });
                }

                window.log(`Account created: ${result.user.email}`, 'success');
            } catch (error) {
                window.log(`Sign up error: ${error.message}`, 'error');
            }
        };

        window.testSignIn = async () => {
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;

            if (!email || !password) {
                window.log('Please enter email and password', 'error');
                return;
            }

            try {
                window.log('Signing in...', 'info');
                const result = await signInWithEmailAndPassword(auth, email, password);
                window.log(`Signed in: ${result.user.email}`, 'success');
            } catch (error) {
                window.log(`Sign in error: ${error.message}`, 'error');
            }
        };

        window.testGoogleSignIn = async () => {
            try {
                window.log('Opening Google sign in popup...', 'info');
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                window.log(`Signed in with Google: ${result.user.email}`, 'success');
            } catch (error) {
                window.log(`Google sign in error: ${error.message}`, 'error');
            }
        };

        window.testSignOut = async () => {
            try {
                await signOut(auth);
                window.log('Signed out successfully', 'success');
            } catch (error) {
                window.log(`Sign out error: ${error.message}`, 'error');
            }
        };

        // Firestore test functions
        window.testSaveSession = async () => {
            const user = auth.currentUser;
            if (!user) {
                window.log('Please sign in first', 'error');
                return;
            }

            try {
                window.log('Saving test session...', 'info');

                const testSession = {
                    userUid: user.uid,
                    summary: {
                        aiGeneratedSummary: "This is a test conversation summary generated for testing purposes.",
                        duration: 120,
                        turnCount: 10,
                        userMessageCount: 5,
                        aiMessageCount: 5,
                        startTime: Date.now() - 120000,
                        endTime: Date.now()
                    },
                    transcript: [
                        { role: 'user', text: 'Hello, this is a test message', timestamp: Date.now() - 120000 },
                        { role: 'assistant', text: 'Hello! How can I help you today?', timestamp: Date.now() - 110000 },
                        { role: 'user', text: 'I am testing the save function', timestamp: Date.now() - 100000 },
                        { role: 'assistant', text: 'Great! The save function is working properly.', timestamp: Date.now() - 90000 }
                    ],
                    createdAt: Date.now(),
                    tags: ['test', 'debug'],
                    isFavorite: false
                };

                const docRef = await addDoc(
                    collection(db, 'users', user.uid, 'sessions'),
                    testSession
                );

                window.log(`‚úÖ Session saved with ID: ${docRef.id}`, 'success');
                document.getElementById('sessionResults').innerHTML = `
                    <div class="log-entry log-success">
                        Session saved successfully!<br>
                        ID: ${docRef.id}<br>
                        Path: users/${user.uid}/sessions/${docRef.id}
                    </div>
                `;
            } catch (error) {
                window.log(`Save session error: ${error.message}`, 'error');
            }
        };

        window.testGetSessions = async () => {
            const user = auth.currentUser;
            if (!user) {
                window.log('Please sign in first', 'error');
                return;
            }

            try {
                window.log('Fetching sessions...', 'info');

                const q = query(
                    collection(db, 'users', user.uid, 'sessions'),
                    orderBy('createdAt', 'desc'),
                    limit(10)
                );

                const snapshot = await getDocs(q);
                const sessions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                window.log(`Found ${sessions.length} sessions`, 'success');

                const resultsDiv = document.getElementById('sessionResults');
                if (sessions.length === 0) {
                    resultsDiv.innerHTML = '<div class="log-entry">No sessions found</div>';
                } else {
                    resultsDiv.innerHTML = sessions.map((session, i) => `
                        <div class="log-entry log-success">
                            <strong>Session ${i + 1}</strong><br>
                            ID: ${session.id}<br>
                            Summary: ${session.summary?.aiGeneratedSummary?.substring(0, 100)}...<br>
                            Messages: ${session.summary?.turnCount || 0}<br>
                            Created: ${new Date(session.createdAt).toLocaleString()}
                        </div>
                    `).join('');
                }

                // Store for delete test
                window.lastSessionId = sessions[0]?.id;
            } catch (error) {
                window.log(`Get sessions error: ${error.message}`, 'error');
            }
        };

        window.testDeleteLastSession = async () => {
            const user = auth.currentUser;
            if (!user) {
                window.log('Please sign in first', 'error');
                return;
            }

            if (!window.lastSessionId) {
                window.log('No session to delete. Get sessions first.', 'error');
                return;
            }

            try {
                window.log(`Deleting session ${window.lastSessionId}...`, 'info');

                await deleteDoc(
                    collection(db, 'users', user.uid, 'sessions').doc(window.lastSessionId)
                );

                window.log(`Session deleted: ${window.lastSessionId}`, 'success');
                window.lastSessionId = null;
            } catch (error) {
                window.log(`Delete session error: ${error.message}`, 'error');
            }
        };

        window.log('Firebase test page loaded successfully', 'success');
    </script>
</body>
</html>
